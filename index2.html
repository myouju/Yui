<script>
    function formatDateToJapanese(date) {
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString();
        const day = date.getDate().toString();
        return `${year}年${month}月${day}日`;
    }

    function updateSongDetails(songs, CDs, setlists) {
        const songTable = document.getElementById('songTable');
        songTable.innerHTML = ""; // テーブルをリセット

        songs.forEach(song => {
            const matchingCDs = [].concat(song.CDtitle).flatMap(songCDtitle => {
                return CDs.filter(cd => cd.CDtitle === songCDtitle);
            });

            const oldestDate = matchingCDs.length > 0 ? matchingCDs.reduce((oldest, current) => {
                const oldestDate = new Date(oldest.date.replace(/年|月/g, '-').replace(/日/g, ''));
                const currentDate = new Date(current.date.replace(/年|月/g, '-').replace(/日/g, ''));
                return oldestDate < currentDate ? oldest : current;
            }) : { date: 'No release date found' };

            const performanceData = setlists.reduce((acc, setlist) => {
                const date = new Date(setlist.date.replace(/年|月/g, '-').replace(/日/g, ''));
                
                const songsArray = Array.isArray(setlist.setlist) ? setlist.setlist : [setlist.setlist];
                if (!Array.isArray(setlist.encore)) {
                    songsArray.push(setlist.encore); // If encore is not an array, treat it as a single element array
                } else {
                    songsArray.push(...setlist.encore);
                }
                if (setlist.Wencore) songsArray.push(setlist.Wencore);

                const titles = songsArray.reduce((acc, title) => {
                    if (typeof title === 'object' && 'medley' in title) {
                        acc.push(...title.medley);
                    } else {
                        acc.push(title);
                    }
                    return acc;
                }, []);

                // 楽曲がセットリストに含まれている場合、カウントを増加
                if (titles.includes(song.title)) {
                    acc.count += 1;
                    // 最終披露日を更新
                    if (!acc.latestDate || date > acc.latestDate) {
                        acc.latestDate = date;
                        acc.id = setlist.id;
                    }
                }

                return acc;
            }, { count: 0, latestDate: null, id: null });

            const formattedDate = oldestDate.date !== 'No release date found' ? oldestDate.date : 'No release date found';
            const latestPerformanceDate = performanceData.latestDate ? formatDateToJapanese(performanceData.latestDate) : '未披露';

            const lyricsClass = song.lyrics.includes('小倉唯') ? 'pink-cell' : '';
            const musicClass = song.music.includes('小倉唯') ? 'pink-cell' : '';
            
            const callLink = song.call ? `<a href="https://yuicom-callbook.hatenablog.com/entry/${song.call}" target="_blank">コール表</a>` : '';
            const MVLink = song.MVlink ? `<a href="https://www.youtube.com/watch?v=${song.MVlink}" target="_blank">MV</a>` : '';
            const videoLink = song.videolink ? `<a href="https://www.youtube.com/watch?v=${song.videolink}" target="_blank">ライブ映像</a>` : '';
            
            const row = `
            <tr>
                <td><a href="https://www.uta-net.com/song/${song.utanet}">${song.title}</a></td>
                <td>${callLink}</td>
                <td>${MVLink}</td>
                <td>${videoLink}</td>
                <td>${performanceData.count || 0}</td>
                <td>${latestPerformanceDate}</td>
                <td>${song.lyrics}</td>
                <td>${song.music}</td>
                <td>${song.arranger}</td>
                <td>${song.length}</td>
                <td>${song.CDtitle}</td>
                <td>${song.releaseDate || '未発表'}</td>
            </tr>
            `;
            songTable.innerHTML += row;
        });
    }

    Promise.all([
        fetch('song.json').then(response => response.json()),
        fetch('CD.json').then(response => response.json()),
        fetch('setlist.json').then(response => response.json())
    ]).then(([songs, CDs, setlists]) => {
        const artistFilter = document.querySelectorAll('input[name="artist"]');
        
        // アーティスト選択時のフィルタリング
        artistFilter.forEach(radio => {
            radio.addEventListener('change', () => {
                const selectedArtist = document.querySelector('input[name="artist"]:checked').value;
                const filteredSongs = songs.filter(song => song.artist === selectedArtist);
                updateSongDetails(filteredSongs, CDs, setlists);
            });
        });

        // 初期表示
        const selectedArtist = document.querySelector('input[name="artist"]:checked').value;
        const filteredSongs = songs.filter(song => song.artist === selectedArtist);
        updateSongDetails(filteredSongs, CDs, setlists);
    }).catch(error => console.error('Failed to fetch data:', error));
</script>
